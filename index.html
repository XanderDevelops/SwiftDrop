<!DOCTYPE html>
<html>
<head>
    <title>SwiftDrop - Local File Transfer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            color: #333;
        }

        #app-container {
            width: 450px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        h1 { font-size: 1.8rem; color: #1a237e; margin-bottom: 20px; }
        h2 { font-size: 1.5rem; margin-bottom: 10px; }
        h3 { margin-top: 20px; }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            margin: 5px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            border: none;
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn:hover { transform: translateY(-2px); }

        .btn-primary { background-color: #1976d2; color: white; }
        .btn-primary:hover { background-color: #1565c0; }

        .btn-secondary { background-color: #f0f2f5; color: #333; border: 1px solid #d1d8e0; }
        .btn-secondary:hover { background-color: #e9ecef; }
        
        #drop-zone {
            border: 2px dashed #d1d8e0;
            border-radius: 12px;
            padding: 40px 20px;
            margin-top: 20px;
            cursor: pointer;
        }
        input[type="file"] { display: none; }

        textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #d1d8e0;
            font-family: monospace;
            font-size: 0.9rem;
            box-sizing: border-box;
            resize: none;
        }
        textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 5px rgba(25, 118, 210, 0.5);
        }

        /* Progress Bar */
        #progress-bar-container { width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; overflow: hidden; margin: 15px 0 5px 0; }
        #progress-bar { width: 0; height: 100%; background-color: #1976d2; border-radius: 5px; transition: width 0.2s ease-in-out; }
        #file-name { font-weight: 600; color: #333; word-break: break-all; margin-bottom: 20px; }

    </style>
</head>
<body>
    <div id="app-container">
        <h1>SwiftDrop</h1>

        <!-- Step 1: Choose Role -->
        <div id="role-selection-view">
            <h2>What would you like to do?</h2>
            <button id="start-send-button" class="btn btn-primary">Send a File</button>
            <button id="start-receive-button" class="btn btn-primary">Receive a File</button>
        </div>

        <!-- Sender Step 2: Select a File -->
        <div id="file-selection-view" style="display: none;">
            <h2>Select a File to Send</h2>
            <div id="drop-zone">
                <p>Drag & Drop file</p>
                <p>or</p>
                <label for="file-input" class="btn btn-primary">Select File</label>
                <input type="file" id="file-input">
            </div>
            <p id="selected-file-name"></p>
            <button id="sender-back-button" class="btn btn-secondary">Back</button>
        </div>
        
        <!-- Handshake View for both Sender and Receiver -->
        <div id="handshake-view" style="display: none;">
            <div id="sender-handshake-content">
                <h3>Step 1: Your Sender Code</h3>
                <p>Copy this code and give it to the Receiver.</p>
                <textarea id="sender-code-textarea" readonly rows="4"></textarea>
                <h3>Step 2: Their Receiver Code</h3>
                <p>Paste the code from the Receiver below.</p>
                <textarea id="receiver-code-textarea" placeholder="Paste receiver's code here..." rows="4"></textarea>
                <button id="connect-button" class="btn btn-primary">Connect</button>
                <button id="sender-cancel-button" class="btn btn-secondary">Cancel</button>
            </div>
            <div id="receiver-handshake-content">
                <h3>Step 1: Their Sender Code</h3>
                <p>Paste the code from the Sender below.</p>
                <textarea id="receiver-paste-sender-code" placeholder="Paste sender's code here..." rows="4"></textarea>
                <h3>Step 2: Your Receiver Code</h3>
                <p>Copy this code and give it back to the Sender.</p>
                <textarea id="receiver-show-own-code" readonly rows="4"></textarea>
                 <div id="receiver-waiting-message" style="display:none;">
                    <h3>Waiting for Sender...</h3>
                    <p>Once the sender connects, the download will begin.</p>
                </div>
                <button id="receiver-cancel-button" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
        
        <!-- Progress View -->
        <div id="progress-view" style="display: none;">
            <h3 id="status">Transferring...</h3>
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <p id="progress-text"></p>
        </div>
        
        <!-- Send Complete View -->
        <div id="send-complete-view" style="display: none;">
             <h2>File Sent!</h2>
             <p>The file has been successfully sent.</p>
             <button id="send-another-button" class="btn btn-primary">Send Another File</button>
        </div>
        
        <!-- Receive Complete View -->
        <div id="receive-complete-view" style="display: none;">
            <h2>Download Complete!</h2>
            <p id="file-name"></p>
            <button id="receive-another-button" class="btn btn-primary">Receive Another</button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script>
        // --- All the JavaScript logic goes here ---
        const streamSaver = window.streamSaver;

        // --- UI Element Map ---
        const views = {
            roleSelection: document.getElementById('role-selection-view'),
            fileSelection: document.getElementById('file-selection-view'),
            handshake: document.getElementById('handshake-view'),
            progress: document.getElementById('progress-view'),
            sendComplete: document.getElementById('send-complete-view'),
            receiveComplete: document.getElementById('receive-complete-view')
        };
        const senderHandshakeContent = document.getElementById('sender-handshake-content');
        const receiverHandshakeContent = document.getElementById('receiver-handshake-content');

        // --- State & Config ---
        let peerConnection;
        let dataChannel;
        let selectedFile;
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- UI Management ---
        function showView(viewName) {
            for (let key in views) views[key].style.display = 'none';
            views[viewName].style.display = 'block';
        }

        function resetApp() {
            if (peerConnection) peerConnection.close();
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('selected-file-name').textContent = '';
            showView('roleSelection');
        }

        // --- Role Selection ---
        document.getElementById('start-send-button').addEventListener('click', () => showView('fileSelection'));
        document.getElementById('start-receive-button').addEventListener('click', startReceiverFlow);
        
        // --- SENDER WORKFLOW ---
        document.getElementById('sender-back-button').addEventListener('click', resetApp);
        document.getElementById('file-input').addEventListener('change', e => handleFileSelect(e.target.files[0]));
        document.getElementById('drop-zone').addEventListener('dragover', e => { e.preventDefault(); });
        document.getElementById('drop-zone').addEventListener('drop', e => { e.preventDefault(); handleFileSelect(e.dataTransfer.files[0]); });

        function handleFileSelect(file) {
            if (file) {
                selectedFile = file;
                document.getElementById('selected-file-name').textContent = `Selected: ${file.name}`;
                createOffer();
            }
        }

        async function createOffer() {
            peerConnection = new RTCPeerConnection(configuration);
            dataChannel = peerConnection.createDataChannel('fileTransfer');
            setupDataChannelHandlers();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            peerConnection.onicecandidate = event => {
                if (!event.candidate) {
                    document.getElementById('sender-code-textarea').value = JSON.stringify(peerConnection.localDescription);
                    receiverHandshakeContent.style.display = 'none';
                    senderHandshakeContent.style.display = 'block';
                    showView('handshake');
                }
            };
        }

        document.getElementById('connect-button').addEventListener('click', async () => {
            if (!document.getElementById('receiver-code-textarea').value) return alert('Please paste the Receiver Code.');
            try {
                const answer = JSON.parse(document.getElementById('receiver-code-textarea').value);
                await peerConnection.setRemoteDescription(answer);
            } catch (e) {
                alert('Invalid Receiver Code. Please try again.');
            }
        });

        // --- RECEIVER WORKFLOW ---
        function startReceiverFlow() {
            peerConnection = new RTCPeerConnection(configuration);
            peerConnection.ondatachannel = event => {
                dataChannel = event.channel;
                setupDataChannelHandlers();
            };

            const senderCodeInput = document.getElementById('receiver-paste-sender-code');
            senderCodeInput.addEventListener('input', async () => {
                if (!senderCodeInput.value) return;
                try {
                    const offer = JSON.parse(senderCodeInput.value);
                    await peerConnection.setRemoteDescription(offer);

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    peerConnection.onicecandidate = event => {
                        if (!event.candidate) {
                            document.getElementById('receiver-show-own-code').value = JSON.stringify(peerConnection.localDescription);
                            document.getElementById('receiver-waiting-message').style.display = 'block';
                        }
                    };
                } catch (e) {
                    alert('Invalid Sender Code. Please try again.');
                    resetApp();
                }
            });
            
            senderHandshakeContent.style.display = 'none';
            receiverHandshakeContent.style.display = 'block';
            showView('handshake');
        }

        // --- Cancel/Reset Buttons ---
        document.getElementById('sender-cancel-button').addEventListener('click', resetApp);
        document.getElementById('receiver-cancel-button').addEventListener('click', resetApp);
        document.getElementById('send-another-button').addEventListener('click', resetApp);
        document.getElementById('receive-another-button').addEventListener('click', resetApp);
        
        // --- DATA TRANSFER LOGIC (Works for both roles) ---
        function setupDataChannelHandlers() {
            dataChannel.onopen = () => {
                if (selectedFile) { // Sender starts the transfer
                    showView('progress');
                    sendFile();
                }
            };

            let writer;
            let receivedSize = 0;
            let fileInfo = {};

            dataChannel.onmessage = event => {
                const { data } = event;
                if (typeof data === 'string') {
                    fileInfo = JSON.parse(data);
                    receivedSize = 0;
                    writer = streamSaver.createWriteStream(fileInfo.name, { size: fileInfo.size }).getWriter();
                    showView('progress');
                    document.getElementById('status').textContent = `Receiving: ${fileInfo.name}`;
                } else if (writer) {
                    writer.write(new Uint8Array(data));
                    receivedSize += data.byteLength;
                    const progress = Math.round((receivedSize / fileInfo.size) * 100);
                    document.getElementById('progress-bar').style.width = `${progress}%`;
                    document.getElementById('progress-text').textContent = `${progress}%`;

                    if (receivedSize === fileInfo.size) {
                        writer.close();
                        document.getElementById('file-name').textContent = `${fileInfo.name} saved to your Downloads.`;
                        showView('receiveComplete');
                    }
                }
            };
        }

        async function sendFile() {
            const CHUNK_SIZE = 262144;
            document.getElementById('status').textContent = `Sending: ${selectedFile.name}`;
            dataChannel.send(JSON.stringify({ name: selectedFile.name, size: selectedFile.size }));

            let offset = 0;
            const fileReader = new FileReader();
            
            function readSlice(o) {
                const slice = selectedFile.slice(o, o + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            }

            fileReader.onload = async event => {
                // Wait if buffer is full (backpressure)
                while (dataChannel.bufferedAmount > dataChannel.bufferedAmountLowThreshold) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                dataChannel.send(event.target.result);
                offset += event.target.result.byteLength;

                const progress = Math.round((offset / selectedFile.size) * 100);
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${progress}%`;

                if (offset < selectedFile.size) {
                    readSlice(offset);
                } else {
                    showView('sendComplete');
                }
            };
            readSlice(0);
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', resetApp);
    </script>
</body>
</html>